/* ---------------------------------------------------- */
/*  Generated by Enterprise Architect Version 12.1 		*/
/*  Created On : 27-mai-2016 10:12:32 				*/
/*  DBMS       : MySql 						*/
/* ---------------------------------------------------- */

SET FOREIGN_KEY_CHECKS=0 
;

/* Drop Tables */

DROP TABLE IF EXISTS `chunks` CASCADE
;

DROP TABLE IF EXISTS `files` CASCADE
;

DROP TABLE IF EXISTS `peers` CASCADE
;

DROP TABLE IF EXISTS `replicas` CASCADE
;

/* Create Tables */

CREATE TABLE `chunks`
(
	`id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
	`file` CHAR(36) NOT NULL,
	`number` INT NOT NULL,
	`minReplicas` INT NOT NULL,
	`secretKey` BINARY(128) NOT NULL,
	CONSTRAINT `PK_chunks` PRIMARY KEY (`id` ASC)
)

;

CREATE TABLE `files`
(
	`uuid` CHAR(36) NOT NULL,
	`peer` CHAR(36) NOT NULL,
	`name` VARCHAR(256) NOT NULL,
	CONSTRAINT `PK_files` PRIMARY KEY (`uuid` ASC)
)

;

CREATE TABLE `peers`
(
	`serial_number` CHAR(36) NOT NULL,
	CONSTRAINT `PK_peers` PRIMARY KEY (`serial_number` ASC)
)

;

CREATE TABLE `replicas`
(
	`peer` CHAR(36) NOT NULL,
	`chunk` INT UNSIGNED NOT NULL,
	CONSTRAINT `PK_peer_chunk` PRIMARY KEY (`peer` ASC, `chunk` ASC)
)

;

/* Create Primary Keys, Indexes, Uniques, Checks */

ALTER TABLE `chunks` 
 ADD CONSTRAINT `UK_file_chunk` UNIQUE (`number` ASC, `file` ASC)
;

ALTER TABLE `chunks` 
 ADD INDEX `IXFK_chunks_files` (`file` ASC)
;

ALTER TABLE `files` 
 ADD INDEX `IXFK_files_peers` (`peer` ASC)
;

ALTER TABLE `replicas` 
 ADD INDEX `IXFK_backups_chunks` (`chunk` ASC)
;

ALTER TABLE `replicas` 
 ADD INDEX `IXFK_backups_peers` (`peer` ASC)
;

/* Create Foreign Key Constraints */

ALTER TABLE `chunks` 
 ADD CONSTRAINT `FK_chunks_files`
	FOREIGN KEY (`file`) REFERENCES `files` (`uuid`) ON DELETE Restrict ON UPDATE Cascade
;

ALTER TABLE `files` 
 ADD CONSTRAINT `FK_files_peers`
	FOREIGN KEY (`peer`) REFERENCES `peers` (`serial_number`) ON DELETE Restrict ON UPDATE Cascade
;

ALTER TABLE `replicas` 
 ADD CONSTRAINT `FK_backups_chunks`
	FOREIGN KEY (`chunk`) REFERENCES `chunks` (`id`) ON DELETE Restrict ON UPDATE Cascade
;

ALTER TABLE `replicas` 
 ADD CONSTRAINT `FK_backups_peers`
	FOREIGN KEY (`peer`) REFERENCES `peers` (`serial_number`) ON DELETE Restrict ON UPDATE Cascade
;

SET FOREIGN_KEY_CHECKS=1 
;
